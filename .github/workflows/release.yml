name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ï¼š1.0.13ï¼‰'
        required: true
        default: '1.0.13'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: è·å–ç‰ˆæœ¬å·
        id: get_version
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi
      
      - name: å®‰è£…ä¾èµ–
        run: npm install
      
      - name: æ„å»º NSIS å®‰è£…ç¨‹åº
        run: npm run build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: æ„å»ºä¾¿æºç‰ˆ
        run: npm run build:portable
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: åˆ—å‡ºæ„å»ºäº§ç‰©
        shell: bash
        run: |
          echo "=== dist ç›®å½•å†…å®¹ ==="
          ls -lah dist/ || echo "dist ç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "=== dist_windows ç›®å½•å†…å®¹ ==="
          ls -lah dist_windows/ || echo "dist_windows ç›®å½•ä¸å­˜åœ¨"
      
      - name: ä¸Šä¼  NSIS å®‰è£…ç¨‹åº
        uses: actions/upload-artifact@v4
        with:
          name: å€’è®¡æ—¶å°ç»„ä»¶-${{ steps.get_version.outputs.VERSION }}-Setup
          path: |
            dist/*.exe
            dist/**/*.exe
          if-no-files-found: error
      
      - name: ä¸Šä¼ ä¾¿æºç‰ˆ
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: å€’è®¡æ—¶å°ç»„ä»¶-${{ steps.get_version.outputs.VERSION }}-Portable
          path: |
            dist/*Portable*.exe
            dist/**/*Portable*.exe
          if-no-files-found: warn
      
      - name: åˆ›å»º GitHub Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.exe
            dist/**/*.exe
          draft: false
          prerelease: false
          generate_release_notes: true
          name: ç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## ğŸ‰ æ¡Œé¢å€’è®¡æ—¶å°ç»„ä»¶ v${{ steps.get_version.outputs.VERSION }}
            
            ### ğŸ“¦ ä¸‹è½½
            - **å®‰è£…ç‰ˆ**ï¼šå€’è®¡æ—¶å°ç»„ä»¶-${{ steps.get_version.outputs.VERSION }}-Setup.exe
            - **ä¾¿æºç‰ˆ**ï¼šå€’è®¡æ—¶å°ç»„ä»¶-${{ steps.get_version.outputs.VERSION }}-Portable.exe
            
            ### ğŸ“ æ›´æ–°å†…å®¹
            è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
            
            ### ğŸ’¡ ä½¿ç”¨è¯´æ˜
            è¯·æŸ¥çœ‹ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
